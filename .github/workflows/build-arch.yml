name: Build Azul Java (Reusable)

on:
  workflow_call:
    inputs:
      arch:
        required: true
        type: string
      java_version:
        required: true
        type: string
      download_url:
        required: true
        type: string

    outputs:
      digest:
        description: "Image digest"
        value: ${{ jobs.build.outputs.digest }}

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - uses: actions/checkout@v3

      - name: Download Azul JRE
        run: wget -O azul.tar.gz "${{ inputs.download_url }}"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_NAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      # ⭐ Normalize arch for tagging (arm/v7 → armv7)
      - name: Normalize arch for tagging
        id: norm
        run: |
          TAG_ARCH=$(echo "${{ inputs.arch }}" | sed 's|/||g')
          echo "tag_arch=$TAG_ARCH" >> $GITHUB_OUTPUT

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/${{ inputs.arch }}
          push: true
          provenance: false
          sbom: false
          tags: |
            bskjon/azuljava:${{ inputs.java_version }}-${{ steps.norm.outputs.tag_arch }}
          build-args: |
            JRE=${{ inputs.java_version }}
